// lib/core/services/gemini_adviser_service.dart
import 'dart:developer';
import 'package:google_generative_ai/google_generative_ai.dart';
import '../config/app_config.dart'; // Import AppConfig to get the key

class GeminiAdviserService {
  // --- UPDATED: Load key from AppConfig ---
  static final String _apiKey = AppConfig.geminiApiKey;
  late final GenerativeModel _model;
  late final String _modelName; // Store the model name

  static final GeminiAdviserService _instance =
      GeminiAdviserService._internal();
  factory GeminiAdviserService() => _instance;
  
  GeminiAdviserService._internal() {
    // Using the model from your original file
    _modelName = 'gemini-2.5-flash'; // Store the name
    _model = GenerativeModel(
      model: _modelName, 
      apiKey: _apiKey,
      generationConfig: GenerationConfig(
        temperature: 0.7,
        topK: 40,
        topP: 0.9,
        maxOutputTokens: 1000,
      ),
      safetySettings: [
        SafetySetting(HarmCategory.harassment, HarmBlockThreshold.medium),
        SafetySetting(HarmCategory.hateSpeech, HarmBlockThreshold.medium),
        SafetySetting(HarmCategory.sexuallyExplicit, HarmBlockThreshold.medium),
        SafetySetting(HarmCategory.dangerousContent, HarmBlockThreshold.medium),
      ],
    );
  }

  // --- NEW METHOD for Audio "Friend" Feature ---
  /// Get a conversational response based on user's speech and emotion.
  Future<String> getConversationalAdvice({
    required String userSpeech,
    required String detectedEmotion,
    String? userName,
    String language = 'English', // Target language for the AI's response
  }) async {
    try {
      log('ü§ñ Getting conversational advice for: "$userSpeech" (Emotion: $detectedEmotion) in $language');
      
      final prompt = _buildConversationalPrompt(
        userSpeech: userSpeech,
        emotion: detectedEmotion,
        language: language,
        userName: userName,
      );

      final content = [Content.text(prompt)];
      final response = await _model.generateContent(content);

      if (response.text != null && response.text!.isNotEmpty) {
        return response.text!;
      } else {
        log('‚ùå Empty response from Gemini API for conversational advice');
        throw Exception('Empty response from Gemini API');
      }
    } catch (e) {
      log('‚ùå Error getting conversational advice: $e');
      // Fallback to simpler advice if conversational prompt fails
      return _getFallbackAdvice(detectedEmotion, language); // This line is now fixed
    }
  }

  /// Build personalized prompt for the virtual friend
  String _buildConversationalPrompt({
    required String userSpeech,
    required String emotion,
    String language = 'English',
    String? userName,
  }) {
    final languageInstruction = _getLanguageInstruction(language);
    final userNameInfo = userName != null ? " The user's name is $userName." : "";

    return '''
    You are MindHeal AI, a compassionate, warm, and wise virtual best friend and counselor.
    A user is talking to you. You have analyzed WHAT they said and HOW they said it (their emotional tone).$userNameInfo

    **CRITICAL LANGUAGE REQUIREMENT:**
    $languageInstruction

    **Analysis of User's Input:**
    - **What they said (Text):** "$userSpeech"
    - **How they said it (Emotion):** ${emotion.toUpperCase()}

    **Your Role & Guidelines:**
    1.  **Act as a supportive friend, NOT a robot.** Be warm, empathetic, and conversational. Use "you".
    2.  **Acknowledge BOTH text and emotion.** This is crucial.
    3.  **If Text and Emotion conflict** (e.g., Text: "I'm fine", Emotion: "SAD"), gently explore it.
        (e.g., "You say you're fine, but I'm sensing some sadness in your voice. It's okay to not be okay. What's on your mind?")
    4.  **If Text and Emotion match** (e.g., Text: "I'm so tired of this", Emotion: "SAD"), validate their feelings.
        (e.g., "I hear that. It sounds like you're feeling completely exhausted and sad, and that's a really tough place to be.")
    5.  **Handle distressing text (like "I an tired of this life i don't want this life") with extreme care:**
        -   Validate their pain immediately (e.g., "I hear how much pain you're in. That sounds incredibly heavy and difficult.").
        -   Offer gentle, hopeful perspective (e.g., "Please hold on. That feeling, as overwhelming as it is, can pass. Life is very beautiful, and there is strength in you, even when it's hard to see. God is with you. Let's focus just on this moment.").
    6.  **Handle positive text/emotion** (e.g., "I think I am good today"):
        -   Encourage them! (e.g., "That's wonderful to hear! And why just 'think' you are good? Be actual good! Live your life, enjoy it! What's making today feel good?")
    7.  **Keep responses to 2-4 supportive sentences.**
    
    Please provide your compassionate, friendly response now:
    ''';
  }

  // --- ORIGINAL METHOD for Image Detection ---
  /// Get personalized emotional advice based on detected mood (for images/camera)
  Future<String> getEmotionalAdvice({
    required String detectedEmotion,
    required double confidence,
    String? additionalContext,
    String language = 'English',
  }) async {
    try {
      log('ü§ñ Getting emotional advice for: $detectedEmotion with confidence: ${(confidence * 100).toInt()}% in $language');
      log('üîë API Key configured: ${isConfigured}');

      final prompt = _buildAdvicePrompt(
        emotion: detectedEmotion,
        confidence: confidence,
        context: additionalContext,
        language: language,
      );

      log('üìù Generated prompt length: ${prompt.length} characters');
      log('üìù First 200 chars of prompt: ${prompt.substring(0, prompt.length > 200 ? 200 : prompt.length)}...');

      final content = [Content.text(prompt)];

      log('üåê Calling Gemini API with model: $_modelName');
      final response = await _model.generateContent(content);

      log('üì® Received response from Gemini API');

      if (response.text != null && response.text!.isNotEmpty) {
        log('‚úÖ Received advice response length: ${response.text!.length} characters');
        log('‚úÖ First 100 chars: ${response.text!.substring(0, response.text!.length > 100 ? 100 : response.text!.length)}...');
        return response.text!;
      } else {
        log('‚ùå Empty response from Gemini API for emotional advice');
        throw Exception('Empty response from Gemini API');
      }
    } catch (e) {
      log('‚ùå Error getting emotional advice: $e');
      log('üîÑ Using fallback advice for $detectedEmotion in $language');
      return _getFallbackAdvice(detectedEmotion, language); // This line is also now fixed
    }
  }

  /// Build personalized prompt based on emotion and context
  String _buildAdvicePrompt({
    required String emotion,
    required double confidence,
    String? context,
    String language = 'English',
  }) {
    final confidenceLevel = _getConfidenceDescription(confidence);
    final languageInstruction = _getLanguageInstruction(language);

    return '''
You are MindHeal AI, a compassionate and professional mental wellness counselor and supportive friend. A person has just had their emotional state analyzed, and you need to provide personalized, empathetic advice.

**CRITICAL LANGUAGE REQUIREMENT:**
$languageInstruction

**Analysis Results:**
- Detected Emotion: ${emotion.toUpperCase()}
- Confidence Level: ${(confidence * 100).toInt()}% ($confidenceLevel)
${context != null ? '- Additional Context: $context' : ''}

**Your Role:**
Act as both a caring friend and a professional counselor. Provide advice that is:
- Warm, empathetic, and understanding
- Practical and actionable
- Supportive without being overly clinical
- Encouraging and hope-filled
- Personalized to the specific emotion detected

**Response Guidelines:**
1. Start with validation and understanding of their current emotional state
2. Provide 2-3 specific, actionable suggestions tailored to this emotion
3. Include a gentle encouragement or affirmation
4. Keep the tone conversational yet professional
5. Limit response to 3-4 sentences for easy reading
6. Use "you" to make it personal

**Emotion-Specific Focus:**
${_getEmotionSpecificGuidance(emotion)}

Please provide your compassionate advice now:
''';
  }

  // --- *** ALL HELPER METHODS ARE NOW INCLUDED *** ---

  /// Get emotion-specific guidance for the prompt
  String _getEmotionSpecificGuidance(String emotion) {
    switch (emotion.toLowerCase()) {
      case 'happy':
      case 'happiness':
        return 'For happiness: Help them savor and extend this positive state, suggest ways to share joy with others, and encourage mindful appreciation of the moment.';

      case 'sad':
      case 'sadness':
        return 'For sadness: Offer gentle comfort, validate their feelings, suggest healthy coping mechanisms, and remind them that this feeling is temporary.';

      case 'angry':
      case 'anger':
        return 'For anger: Help them process this emotion safely, suggest breathing techniques, physical outlets, and ways to address the underlying cause constructively.';

      case 'fear':
        return 'For fear: Provide reassurance, suggest grounding techniques, breathing exercises, and gentle ways to face or understand their concerns.';

      case 'surprise':
        return 'For surprise: Help them process unexpected events, suggest ways to adapt to new situations, and encourage openness to change.';

      case 'disgust':
        return 'For disgust: Help them identify what triggered this feeling, suggest healthy boundaries, and ways to process difficult experiences.';

      case 'neutral':
        return 'For neutral state: Encourage self-reflection, suggest activities for emotional growth, and ways to connect with their inner feelings.';

      default:
        return 'Focus on providing general emotional support and practical coping strategies appropriate for their current state.';
    }
  }

  /// Get confidence level description
  String _getConfidenceDescription(double confidence) {
    if (confidence >= 0.9) return 'Very High Accuracy';
    if (confidence >= 0.8) return 'High Accuracy';
    if (confidence >= 0.7) return 'Good Accuracy';
    if (confidence >= 0.6) return 'Moderate Accuracy';
    return 'Lower Accuracy';
  }

  /// Get language-specific instructions for the AI
  String _getLanguageInstruction(String language) {
    switch (language) {
      case '‡§π‡§ø‡§Ç‡§¶‡•Ä':
        return '''
IMPORTANT: You MUST respond ONLY in Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä) language using Devanagari script. 
- Do NOT use any English words in your response
- Use natural, compassionate Hindi expressions
- Write everything in Hindi including all advice, techniques, and encouragement
- Example of proper Hindi response style: "‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§ö‡§ø‡§Ç‡§§‡§ø‡§§ ‡§Ø‡§æ ‡§°‡§∞‡•á ‡§π‡•Å‡§è ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç..."
''';
      case '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä':
        return '''
IMPORTANT: You MUST respond ONLY in Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä) language using Gujarati script.
- Do NOT use any English words in your response
- Use natural, compassionate Gujarati expressions
- Write everything in Gujarati including all advice, techniques, and encouragement
- Example of proper Gujarati response style: "‡™π‡´Å‡™Ç ‡™∏‡™Æ‡™ú‡´Ä ‡™∂‡™ï‡´Å‡™Ç ‡™õ‡´Å‡™Ç ‡™ï‡´á ‡™§‡™Æ‡´á ‡™ö‡™ø‡™Ç‡™§‡™ø‡™§ ‡™Ö‡™•‡™µ‡™æ ‡™°‡™∞‡™§‡™æ ‡™Ö‡™®‡´Å‡™≠‡™µ‡´ã ‡™õ‡´ã..."
''';
      case 'English':
      default:
        return 'Please respond in clear, compassionate English language that feels warm and supportive.';
    }
  }

  /// Provide fallback advice when API fails
  String _getFallbackAdvice(String emotion, [String language = 'English']) {
    if (language == '‡§π‡§ø‡§Ç‡§¶‡•Ä') {
      return _getHindiFallbackAdvice(emotion);
    } else if (language == '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä') {
      return _getGujaratiFallbackAdvice(emotion);
    }

    switch (emotion.toLowerCase()) {
      case 'happy':
      case 'happiness':
        return "What a wonderful moment! üòä This happiness you're feeling is precious - take a moment to really savor it. Consider sharing this joy with someone you care about, or write down what made you feel this way. Remember, you have the power to create more moments like this.";

      case 'sad':
      case 'sadness':
        return "I can see you're going through a difficult time right now. üíô It's completely okay to feel sad - these emotions are valid and part of being human. Try taking some deep breaths, reaching out to a trusted friend, or engaging in a gentle activity that usually comforts you. This feeling will pass, and brighter days are ahead.";

      case 'angry':
      case 'anger':
        return "I understand you're feeling frustrated or angry right now. üî• Take a few deep breaths and count to ten. Consider going for a walk, doing some physical exercise, or writing down your thoughts. Remember, it's okay to feel angry, but how you express it matters. You have the strength to handle this constructively.";

      case 'fear':
        return "I can sense you're feeling anxious or fearful. ü§ó Remember that you're stronger than you know. Try the 5-4-3-2-1 grounding technique: name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, and 1 you taste. Take slow, deep breaths. You've overcome challenges before, and you can do it again.";

      case 'surprise':
        return "Looks like something unexpected happened! üòÆ Surprises can be overwhelming, but they're also opportunities for growth. Take a moment to process what you're feeling. Sometimes the best things come from unexpected changes. Trust in your ability to adapt and make the most of new situations.";

      case 'disgust':
        return "I can see something has really bothered you. üòî It's important to acknowledge these feelings and understand what triggered them. Consider removing yourself from the situation if possible, practice some calming techniques, and remember that you have the right to set healthy boundaries.";

      case 'neutral':
        return "You seem to be in a calm, balanced state right now. üòå This is actually a wonderful opportunity for self-reflection and planning. Consider what you'd like to feel or achieve today. Sometimes our most peaceful moments give us clarity about what truly matters to us.";

      default:
        return "Whatever you're feeling right now is valid and important. üíô Take a moment to acknowledge your emotions without judgment. Remember that feelings are temporary visitors - they come and go. You have the strength to navigate through this, and it's okay to ask for support when you need it.";
    }
  }

  /// Hindi fallback advice
  String _getHindiFallbackAdvice(String emotion) {
    switch (emotion.toLowerCase()) {
      case 'happy':
      case 'happiness':
        return "‡§ï‡•ç‡§Ø‡§æ ‡§Ö‡§¶‡•ç‡§≠‡•Å‡§§ ‡§ï‡•ç‡§∑‡§£ ‡§π‡•à! üòä ‡§Ü‡§™‡§ï‡•Ä ‡§Ø‡§π ‡§ñ‡•Å‡§∂‡•Ä ‡§¨‡§π‡•Å‡§§ ‡§ï‡•Ä‡§Æ‡§§‡•Ä ‡§π‡•à - ‡§á‡§∏‡•á ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§™‡§≤ ‡§∞‡•Å‡§ï‡•á‡§Ç‡•§ ‡§á‡§∏ ‡§ñ‡•Å‡§∂‡•Ä ‡§ï‡•ã ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§™‡§®‡•á ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç, ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ê‡§∏‡•á ‡§î‡§∞ ‡§™‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•Ä ‡§∂‡§ï‡•ç‡§§‡§ø ‡§π‡•à‡•§";

      case 'sad':
      case 'sadness':
        return "‡§Æ‡•à‡§Ç ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§ï‡§†‡§ø‡§® ‡§¶‡•å‡§∞ ‡§∏‡•á ‡§ó‡•Å‡§ú‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ üíô ‡§â‡§¶‡§æ‡§∏ ‡§π‡•ã‡§®‡§æ ‡§¨‡§ø‡§≤‡•ç‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à - ‡§Ø‡•á ‡§≠‡§æ‡§µ‡§®‡§æ‡§è‡§Ç ‡§µ‡•à‡§ß ‡§π‡•à‡§Ç‡•§ ‡§ï‡•Å‡§õ ‡§ó‡§π‡§∞‡•Ä ‡§∏‡§æ‡§Ç‡§∏‡•á‡§Ç ‡§≤‡•á‡§Ç, ‡§ï‡§ø‡§∏‡•Ä ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§Æ‡§ø‡§§‡•ç‡§∞ ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ø‡§π ‡§≠‡§æ‡§µ‡§®‡§æ ‡§¨‡•Ä‡§§ ‡§ú‡§æ‡§è‡§ó‡•Ä, ‡§î‡§∞ ‡§â‡§ú‡•ç‡§ú‡§µ‡§≤ ‡§¶‡§ø‡§® ‡§Ü‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§π‡•à‡§Ç‡•§";

      case 'angry':
      case 'anger':
        return "‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§ó‡•Å‡§∏‡•ç‡§∏‡•á ‡§Æ‡•á‡§Ç ‡§π‡•à‡§Ç‡•§ üî• ‡§ï‡•Å‡§õ ‡§ó‡§π‡§∞‡•Ä ‡§∏‡§æ‡§Ç‡§∏‡•á‡§Ç ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§¶‡§∏ ‡§§‡§ï ‡§ó‡§ø‡§®‡§§‡•Ä ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§ü‡§π‡§≤‡§®‡•á ‡§ú‡§æ‡§®‡•á ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç, ‡§ó‡•Å‡§∏‡•ç‡§∏‡§æ ‡§π‡•ã‡§®‡§æ ‡§†‡•Ä‡§ï ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§á‡§∏‡•á ‡§ï‡•à‡§∏‡•á ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§π ‡§Æ‡§æ‡§Ø‡§®‡•á ‡§∞‡§ñ‡§§‡§æ ‡§π‡•à‡•§";

      case 'fear':
        return "‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§ö‡§ø‡§Ç‡§§‡§ø‡§§ ‡§Ø‡§æ ‡§°‡§∞‡•á ‡§π‡•Å‡§è ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ü§ó ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§ú‡§ø‡§§‡§®‡§æ ‡§∏‡•ã‡§ö‡§§‡•á ‡§π‡•à‡§Ç ‡§â‡§∏‡§∏‡•á ‡§ï‡§π‡•Ä‡§Ç ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§π‡•à‡§Ç‡•§ ‡•´-‡•™-‡•©-‡•®-‡•ß ‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§°ING ‡§§‡§ï‡§®‡•Ä‡§ï ‡§Ü‡§ú‡§Æ‡§æ‡§è‡§Ç: ‡•´ ‡§ö‡•Ä‡§ú‡•á‡§Ç ‡§ú‡•ã ‡§Ü‡§™ ‡§¶‡•á‡§ñ‡§§‡•á ‡§π‡•à‡§Ç, ‡•™ ‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç ‡§õ‡•Ç ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡•© ‡§ú‡•ã ‡§∏‡•Å‡§®‡§§‡•á ‡§π‡•à‡§Ç, ‡•® ‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç ‡§∏‡•Ç‡§Ç‡§ò ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§î‡§∞ ‡•ß ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§¶ ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ß‡•Ä‡§Æ‡•Ä, ‡§ó‡§π‡§∞‡•Ä ‡§∏‡§æ‡§Ç‡§∏‡•á‡§Ç ‡§≤‡•á‡§Ç‡•§";

      case 'surprise':
        return "‡§≤‡§ó‡§§‡§æ ‡§π‡•à ‡§ï‡•Å‡§õ ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡™ø‡™§ ‡§π‡•Å‡§Ü ‡§π‡•à! üòÆ ‡§Ü‡§∂‡•ç‡§ö‡§∞‡•ç‡§Ø ‡§≠‡§æ‡§∞‡•Ä ‡§≤‡§ó ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡•á ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§ï‡•á ‡§Ö‡§µ‡§∏‡§∞ ‡§≠‡•Ä ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§è‡§ï ‡§™‡§≤ ‡§≤‡•á‡§ï‡§∞ ‡§∏‡•ã‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡§≠‡•Ä-‡§ï‡§≠‡•Ä ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§ö‡•Ä‡§ú‡•á‡§Ç ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§¨‡§¶‡§≤‡§æ‡§µ‡•ã‡§Ç ‡§∏‡•á ‡§Ü‡§§‡•Ä ‡§π‡•à‡§Ç‡•§";

      case 'disgust':
        return "‡§Æ‡•à‡§Ç ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§ï‡•Å‡§õ ‡§ö‡•Ä‡§ú ‡§Ü‡§™‡§ï‡•ã ‡§™‡§∞‡•á‡§∂‡§æ‡§® ‡§ï‡§∞ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ üòî ‡§á‡§® ‡§≠‡§æ‡§µ‡§®‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§∏‡§Æ‡§ù‡§®‡§æ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•à ‡§ï‡§ø ‡§á‡§®‡•ç‡§π‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§¶‡§ø ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã ‡§§‡•ã ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡•á ‡§ñ‡•Å‡§¶ ‡§ï‡•ã ‡§¶‡•Ç‡§∞ ‡§ï‡§∞‡•á‡§Ç, ‡§ï‡•Å‡§õ ‡§∂‡§æ‡§Ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§§‡§ï‡§®‡•Ä‡§ï‡•á‡§Ç ‡§Ö‡§™‡§®‡§æ‡§è‡§Ç‡•§";

      case 'neutral':
        return "‡§Ü‡§™ ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§∂‡§æ‡§Ç‡§§, ‡§∏‡§Ç‡§§‡•Å‡§≤‡§ø‡§§ ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§Æ‡•á‡§Ç ‡§≤‡§ó ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ üòå ‡§Ø‡§π ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ ‡§Æ‡•á‡§Ç ‡§Ü‡§§‡•ç‡§Æ‡§ö‡§ø‡§Ç‡§§‡§® ‡§î‡§∞ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§Ö‡§¶‡•ç‡§≠‡•Å‡§§ ‡§Ö‡§µ‡§∏‡§∞ ‡§π‡•à‡•§ ‡§∏‡•ã‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§Ü‡§ú ‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞‡§®‡§æ ‡§Ø‡§æ ‡§π‡§æ‡§∏‡§ø‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç‡•§";

      default:
        return "‡§Ü‡§™ ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§ú‡•ã ‡§≠‡•Ä ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§µ‡§π ‡§µ‡•à‡§ß ‡§î‡§∞ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•à‡•§ üíô ‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§µ‡§®‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§¨‡§ø‡§®‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§ú‡§ú‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•á ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§™‡§≤ ‡§≤‡•á‡§Ç‡•§ ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§≠‡§æ‡§µ‡§®‡§æ‡§è‡§Ç ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§Ü‡§ó‡§Ç‡§§‡•Å‡§ï ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™‡§Æ‡•á‡§Ç ‡§á‡§∏‡§∏‡•á ‡§®‡§ø‡§™‡§ü‡§®‡•á ‡§ï‡•Ä ‡§∂‡§ï‡•ç‡§§‡§ø ‡§π‡•à‡•§";
    }
  }

  /// Gujarati fallback advice
  String _getGujaratiFallbackAdvice(String emotion) {
    switch (emotion.toLowerCase()) {
      case 'happy':
      case 'happiness':
        return "‡™ï‡´á‡™ü‡™≤‡´ã ‡™Ö‡™¶‡´ç‡™≠‡´Å‡™§ ‡™ï‡´ç‡™∑‡™£ ‡™õ‡´á! üòä ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™Ü ‡™ñ‡´Å‡™∂‡´Ä ‡™ñ‡´Ç‡™¨ ‡™ï‡´Ä‡™Æ‡™§‡´Ä ‡™õ‡´á - ‡™Ü‡™®‡´á ‡™Ö‡™®‡´Å‡™≠‡™µ‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™è‡™ï ‡™ï‡´ç‡™∑‡™£ ‡™∞‡´ã‡™ï‡™æ‡™ì. ‡™Ü ‡™Ü‡™®‡™Ç‡™¶‡™®‡´á ‡™ï‡´ã‡™à ‡™™‡´ç‡™∞‡™ø‡™Ø‡™ú‡™® ‡™∏‡™æ‡™•‡´á ‡™∂‡´á‡™∞ ‡™ï‡™∞‡™µ‡™æ‡™®‡´Å‡™Ç ‡™µ‡™ø‡™ö‡™æ‡™∞‡´ã. ‡™Ø‡™æ‡™¶ ‡™∞‡™æ‡™ñ‡´ã, ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™™‡™æ‡™∏‡´á ‡™Ü‡™µ‡´Ä ‡™µ‡™ß‡´Å ‡™ï‡´ç‡™∑‡™£‡´ã ‡™¨‡™®‡™æ‡™µ‡™µ‡™æ‡™®‡´Ä ‡™∂‡™ï‡´ç‡™§‡™ø ‡™õ‡´á.";

      case 'sad':
      case 'sadness':
        return "‡™π‡´Å‡™Ç ‡™ú‡´ã‡™à ‡™∂‡™ï‡´Å‡™Ç ‡™õ‡´Å‡™Ç ‡™ï‡´á ‡™§‡™Æ‡´á ‡™Ü ‡™∏‡™Æ‡™Ø‡´á ‡™ï‡™†‡™ø‡™® ‡™¶‡´ã‡™∞‡™Æ‡™æ‡™Ç‡™•‡´Ä ‡™™‡™∏‡™æ‡™∞ ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´ã. üíô ‡™â‡™¶‡™æ‡™∏ ‡™•‡™µ‡´Å‡™Ç ‡™∏‡™æ‡™µ ‡™∏‡™æ‡™Æ‡™æ‡™®‡´ç‡™Ø ‡™õ‡´á - ‡™Ü ‡™≤‡™æ‡™ó‡™£‡´Ä‡™ì ‡™Ø‡´ã‡™ó‡´ç‡™Ø ‡™õ‡´á. ‡™•‡´ã‡™°‡´Ä ‡™ä‡™Ç‡™°‡´Ä ‡™∂‡´ç‡™µ‡™æ‡™∏ ‡™≤‡´ã, ‡™ï‡´ã‡™à ‡™µ‡™ø‡™∂‡´ç‡™µ‡™∏‡™®‡´Ä‡™Ø ‡™Æ‡™ø‡™§‡´ç‡™∞ ‡™∏‡™æ‡™•‡´á ‡™µ‡™æ‡™§ ‡™ï‡™∞‡´ã. ‡™Ü ‡™≤‡™æ‡™ó‡™£‡´Ä ‡™™‡™∏‡™æ‡™∞ ‡™•‡™à ‡™ú‡™∂‡´á, ‡™Ö‡™®‡´á ‡™â‡™ú‡™≥‡™æ ‡™¶‡™ø‡™µ‡™∏‡´ã ‡™Ü‡™µ‡™®‡™æ‡™∞‡™æ ‡™õ‡´á.";

      case 'angry':
      case 'anger':
        return "‡™π‡´Å‡™Ç ‡™∏‡™Æ‡™ú‡´Ä ‡™∂‡™ï‡´Å‡™Ç ‡™õ‡´Å‡™Ç ‡™ï‡´á ‡™§‡™Æ‡´á ‡™Ü ‡™∏‡™Æ‡™Ø‡´á ‡™ó‡´Å‡™∏‡´ç‡™∏‡™æ‡™Æ‡™æ‡™Ç ‡™õ‡´ã. üî• ‡™•‡´ã‡™°‡´Ä ‡™ä‡™Ç‡™°‡´Ä ‡™∂‡´ç‡™µ‡™æ‡™∏ ‡™≤‡´ã ‡™Ö‡™®‡´á ‡™¶‡™∏ ‡™∏‡´Å‡™ß‡´Ä ‡™ó‡™£‡™§‡™∞‡´Ä ‡™ï‡™∞‡´ã. ‡™´‡™∞‡™µ‡™æ ‡™ú‡™µ‡™æ‡™®‡´Å‡™Ç ‡™Ö‡™•‡™µ‡™æ ‡™•‡´ã‡™°‡´Ä ‡™∂‡™æ‡™∞‡´Ä‡™∞‡™ø‡™ï ‡™ï‡™∏‡™∞‡™§ ‡™ï‡™∞‡™µ‡™æ‡™®‡´Å‡™Ç ‡™µ‡™ø‡™ö‡™æ‡™∞‡´ã. ‡™Ø‡™æ‡™¶ ‡™∞‡™æ‡™ñ‡´ã, ‡™ó‡´Å‡™∏‡´ç‡™∏‡´ã ‡™•‡™µ‡´ã ‡™†‡´Ä‡™ï ‡™õ‡´á, ‡™™‡™∞‡™Ç‡™§‡´Å ‡™§‡´á‡™®‡´á ‡™ï‡´á‡™µ‡´Ä ‡™∞‡´Ä‡™§‡´á ‡™µ‡´ç‡™Ø‡™ï‡´ç‡™§ ‡™ï‡™∞‡´ã ‡™õ‡´ã ‡™§‡´á ‡™Æ‡™π‡™§‡´ç‡™µ‡™®‡´Å‡™Ç ‡™õ‡´á.";

      case 'fear':
        return "‡™π‡´Å‡™Ç ‡™∏‡™Æ‡™ú‡´Ä ‡™∂‡™ï‡´Å‡™Ç ‡™õ‡´Å‡™Ç ‡™ï‡´á ‡™§‡™Æ‡´á ‡™ö‡™ø‡™Ç‡™§‡™ø‡™§ ‡™Ö‡™•‡™µ‡™æ ‡™°‡™∞‡™§‡™æ ‡™Ö‡™®‡´Å‡™≠‡™µ‡´ã ‡™õ‡´ã. ü§ó ‡™Ø‡™æ‡™¶ ‡™∞‡™æ‡™ñ‡´ã ‡™ï‡´á ‡™§‡™Æ‡´á ‡™§‡™Æ‡´á ‡™µ‡™ø‡™ö‡™æ‡™∞‡´ã ‡™õ‡´ã ‡™§‡´á‡™®‡™æ ‡™ï‡™∞‡™§‡™æ‡™Ç ‡™µ‡™ß‡´Å ‡™Æ‡™ú‡™¨‡´Ç‡™§ ‡™õ‡´ã. ‡´´-‡´™-‡´©-‡´®-‡´ß ‡™ó‡´ç‡™∞‡™æ‡™â‡™®‡´ç‡™°‡™ø‡™Ç‡™ó ‡™ü‡´á‡™ï‡™®‡™ø‡™ï ‡™Ö‡™ú‡™Æ‡™æ‡™µ‡´ã: ‡´´ ‡™µ‡™∏‡´ç‡™§‡´Å‡™ì ‡™ú‡´á ‡™§‡™Æ‡´á ‡™ú‡´Å‡™ì ‡™õ‡´ã, ‡´™ ‡™ú‡´á‡™®‡´á ‡™∏‡´ç‡™™‡™∞‡´ç‡™∂ ‡™ï‡™∞‡´Ä ‡™∂‡™ï‡´ã, ‡´© ‡™ú‡´á ‡™∏‡™æ‡™Ç‡™≠‡™≥‡´ã, ‡´® ‡™ú‡´á‡™®‡´Ä ‡™∏‡´Å‡™ó‡™Ç‡™ß ‡™≤‡™à ‡™∂‡™ï‡´ã, ‡™Ö‡™®‡´á ‡´ß ‡™ú‡´á‡™®‡´ã ‡™∏‡´ç‡™µ‡™æ‡™¶ ‡™≤‡™à ‡™∂‡™ï‡´ã. ‡™ß‡´Ä‡™Æ‡´Ä, ‡™ä‡™Ç‡™°‡´Ä ‡™∂‡´ç‡™µ‡™æ‡™∏ ‡™≤‡´ã.";

      case 'surprise':
        return "‡™≤‡™æ‡™ó‡´á ‡™õ‡´á ‡™ï‡™Ç‡™à‡™ï ‡™Ö‡™£‡™ß‡™æ‡™∞‡´ç‡™Ø‡´Å‡™Ç ‡™•‡™Ø‡´Å‡™Ç ‡™õ‡´á! üòÆ ‡™Ü‡™∂‡´ç‡™ö‡™∞‡´ç‡™Ø ‡™≠‡™æ‡™∞‡´á ‡™≤‡™æ‡™ó‡´Ä ‡™∂‡™ï‡´á, ‡™™‡™∞‡™Ç‡™§‡´Å ‡™§‡´á ‡™µ‡™ø‡™ï‡™æ‡™∏‡™®‡´Ä ‡™§‡™ï‡´ã ‡™™‡™£ ‡™π‡´ã‡™Ø ‡™õ‡´á. ‡™è‡™ï ‡™ï‡´ç‡™∑‡™£ ‡™≤‡™à‡™®‡´á ‡™µ‡™ø‡™ö‡™æ‡™∞‡´ã ‡™ï‡´á ‡™§‡™Æ‡´á ‡™∂‡´Å‡™Ç ‡™Ö‡™®‡´Å‡™≠‡™µ‡´ã ‡™õ‡´ã. ‡™ï‡´á‡™ü‡™≤‡´Ä‡™ï‡™µ‡™æ‡™∞ ‡™∂‡´ç‡™∞‡´á‡™∑‡´ç‡™† ‡™µ‡™∏‡´ç‡™§‡´Å‡™ì ‡™Ö‡™£‡™ß‡™æ‡™∞‡´ç‡™Ø‡™æ ‡™´‡´á‡™∞‡™´‡™æ‡™∞‡´ã‡™•‡´Ä ‡™Ü‡™µ‡´á ‡™õ‡´á.";

      case 'disgust':
        return "‡™π‡´Å‡™Ç ‡™ú‡´ã‡™à ‡™∂‡™ï‡´Å‡™Ç ‡™õ‡´Å‡™Ç ‡™ï‡´á ‡™ï‡™Ç‡™à‡™ï ‡™µ‡™∏‡´ç‡™§‡´Å ‡™§‡™Æ‡™®‡´á ‡™™‡™∞‡´á‡™∂‡™æ‡™® ‡™ï‡™∞‡´Ä ‡™∞‡™π‡´Ä ‡™õ‡´á. üòî ‡™Ü ‡™≤‡™æ‡™ó‡™£‡´Ä‡™ì‡™®‡´á ‡™∏‡´ç‡™µ‡´Ä‡™ï‡™æ‡™∞‡™µ‡´Ä ‡™Ö‡™®‡´á ‡™∏‡™Æ‡™ú‡™µ‡´Ä ‡™Æ‡™π‡™§‡´ç‡™µ‡™™‡´Ç‡™∞‡´ç‡™£ ‡™õ‡´á ‡™ï‡´á ‡™§‡´á‡™Æ‡™®‡´á ‡™∂‡´Å‡™Ç ‡™ü‡´ç‡™∞‡™ø‡™ó‡™∞ ‡™ï‡™∞‡´á ‡™õ‡´á. ‡™ú‡´ã ‡™∂‡™ï‡´ç‡™Ø ‡™π‡´ã‡™Ø ‡™§‡´ã ‡™∏‡´ç‡™•‡™ø‡™§‡™ø‡™•‡´Ä ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™ú‡™æ‡™§‡™®‡´á ‡™¶‡´Ç‡™∞ ‡™ï‡™∞‡´ã, ‡™ï‡´á‡™ü‡™≤‡´Ä‡™ï ‡™∂‡™æ‡™Ç‡™§ ‡™ï‡™∞‡™®‡™æ‡™∞‡´Ä ‡™§‡™ï‡™®‡´Ä‡™ï‡´ã ‡™Ö‡™™‡™®‡™æ‡™µ‡´ã.";

      case 'neutral':
        return "‡™§‡™Æ‡´á ‡™Ü ‡™∏‡™Æ‡™Ø‡´á ‡™∂‡™æ‡™Ç‡™§, ‡™∏‡™Ç‡™§‡´Å‡™≤‡™ø‡™§ ‡™Ö‡™µ‡™∏‡´ç‡™•‡™æ‡™Æ‡™æ‡™Ç ‡™≤‡™æ‡™ó‡´ã ‡™õ‡´ã. üòå ‡™Ü ‡™ñ‡™∞‡´á‡™ñ‡™∞ ‡™Ü‡™§‡´ç‡™Æ‡™ö‡™ø‡™Ç‡™§‡™® ‡™Ö‡™®‡´á ‡™Ø‡´ã‡™ú‡™®‡™æ ‡™¨‡™®‡™æ‡™µ‡™µ‡™æ‡™®‡´Ä ‡™Ö‡™¶‡´ç‡™≠‡´Å‡™§ ‡™§‡™ï ‡™õ‡´á. ‡™µ‡™ø‡™ö‡™æ‡™∞‡´ã ‡™ï‡´á ‡™§‡™Æ‡´á ‡™Ü‡™ú‡´á ‡™∂‡´Å‡™Ç ‡™Ö‡™®‡´Å‡™≠‡™µ‡™µ‡™æ ‡™Ö‡™•‡™µ‡™æ ‡™π‡™æ‡™Ç‡™∏‡™≤ ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™Ç‡™ó‡´ã ‡™õ‡´ã.";

      default:
        return "‡™§‡™Æ‡´á ‡™Ü ‡™∏‡™Æ‡™Ø‡´á ‡™ú‡´á ‡™™‡™£ ‡™Ö‡™®‡´Å‡™≠‡™µ‡´ã ‡™õ‡´ã ‡™§‡´á ‡™Ø‡´ã‡™ó‡´ç‡™Ø ‡™Ö‡™®‡´á ‡™Æ‡™π‡™§‡´ç‡™µ‡™™‡´Ç‡™∞‡´ç‡™£ ‡™õ‡´á. üíô ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™≤‡™æ‡™ó‡™£‡´Ä‡™ì‡™®‡´á ‡™ï‡´ã‡™à ‡™®‡´ç‡™Ø‡™æ‡™Ø ‡™ï‡™∞‡´ç‡™Ø‡™æ ‡™µ‡™ø‡™®‡™æ ‡™∏‡´ç‡™µ‡´Ä‡™ï‡™æ‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™è‡™ï ‡™ï‡´ç‡™∑‡™£ ‡™≤‡´ã. ‡™Ø‡™æ‡™¶ ‡™∞‡™æ‡™ñ‡´ã ‡™ï‡´á ‡™≤‡™æ‡™ó‡™£‡´Ä‡™ì ‡™Ö‡™∏‡´ç‡™•‡™æ‡™Ø‡´Ä ‡™Æ‡´Å‡™≤‡™æ‡™ï‡™æ‡™§‡´Ä‡™ì ‡™õ‡´á. ‡™§‡™Æ‡™æ‡™∞‡™æ‡™Æ‡™æ‡™Ç ‡™Ü‡™®‡´ã ‡™∏‡™æ‡™Æ‡™®‡´ã ‡™ï‡™∞‡™µ‡™æ‡™®‡´Ä ‡™∂‡™ï‡´ç‡™§‡™ø ‡™õ‡´á.";
    }
  }

  /// Get appropriate emoji for emotion
  String getEmotionEmoji(String emotion) {
    switch (emotion.toLowerCase()) {
      case 'happy':
      case 'happiness':
        return 'üòä';
      case 'sad':
      case 'sadness':
        return 'üíô';
      case 'angry':
      case 'anger':
        return 'üî•';
      case 'fear':
        return 'ü§ó';
      case 'surprise':
        return 'üòÆ';
      case 'disgust':
        return 'üòî';
      case 'neutral':
        return 'üòå';
      default:
        return 'üíô';
    }
  }

  /// Test API connection and model availability
  Future<bool> testApiConnection() async {
    try {
      log('üß™ Testing Gemini API connection...');

      if (!isConfigured) {
        log('‚ùå API key not configured properly via AppConfig/dotenv');
        return false;
      }

      final testPrompt =
          'Respond with "API_TEST_SUCCESS" if you can read this message.';
      final content = [Content.text(testPrompt)];

      final response = await _model.generateContent(content);

      if (response.text != null && response.text!.contains("API_TEST_SUCCESS")) {
        log('‚úÖ API test successful. Response: ${response.text}');
        return true;
      } else {
        log('‚ùå API test failed: Unexpected response: ${response.text}');
        return false;
      }
    } catch (e) {
      log('‚ùå API test failed with error: $e');
      return false;
    }
  }

  /// Check if the service is properly configured
  bool get isConfigured =>
      _apiKey.isNotEmpty &&
      !_apiKey.contains('YOUR_API_KEY') &&
      !_apiKey.contains('MISSING_GEMINI_KEY');
}